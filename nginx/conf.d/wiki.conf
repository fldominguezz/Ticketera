server {
    listen 3005 ssl;
    server_name _;

    ssl_certificate /etc/nginx/ssl/nginx.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx.key;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Accept-Encoding "";

        # Inyecci√≥n de script de seguridad y autocompletado avanzado
        sub_filter_types text/html;
        sub_filter '</body>' '<script>
        (function() {
          function check() {
            const path = window.location.pathname;
            const hash = window.location.hash;
            const isLogin = path.includes("/login");
            const isLogout = path.includes("/logout");
            const hasCreds = hash.includes("e=") && hash.includes("p=");
            
            // Si trae credenciales en el hash, marcar como autorizado INMEDIATAMENTE
            if (hasCreds) {
              sessionStorage.setItem("wiki_auth_ok", "true");
            }

            const sessionActive = sessionStorage.getItem("wiki_auth_ok");

            // 1. SEGURIDAD: Si no hay flag de Ticketera y no estamos en login/logout, forzar salida
            if (!isLogin && !isLogout && !sessionActive) {
              console.log("Acceso no autorizado detectado, redirigiendo a logout...");
              window.location.href = "/logout";
              return;
            }

            // 2. AUTOCOMPLETADO: Solo si estamos en login y traemos credenciales
            if (isLogin && hasCreds) {
              const eInput = document.querySelector("input[name=\'email\'], #email, input[type=\'email\']");
              const pInput = document.querySelector("input[name=\'password\'], #password, input[type=\'password\']");
              
              if (eInput && pInput && eInput.value === "") {
                const params = new URLSearchParams(hash.substring(1));
                const email = params.get("e");
                const password = params.get("p");

                const setter = (el, val) => {
                  const nativeSetter = Object.getOwnPropertyDescriptor(Object.getPrototypeOf(el), "value").set;
                  nativeSetter.call(el, val);
                  el.dispatchEvent(new Event("input", { bubbles: true }));
                  el.dispatchEvent(new Event("change", { bubbles: true }));
                };

                setter(eInput, email);
                setter(pInput, password);
                
                setTimeout(() => {
                  const btn = document.querySelector("button[type=\'submit\']");
                  if (btn) btn.click();
                }, 500);
              }
            }
          }

          setInterval(check, 1000);
          check();
        })();
        </script></body>';
        sub_filter_once on;
    }
}
