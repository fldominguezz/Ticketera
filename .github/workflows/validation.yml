name: Total Validation Agent

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Start Services
        run: |
          echo "POSTGRES_USER=postgres" > .env
          echo "POSTGRES_PASSWORD=postgres" >> .env
          echo "POSTGRES_DB=ticketera_db" >> .env
          echo "DATABASE_URL=postgresql+asyncpg://postgres:postgres@db:5432/ticketera_db" >> .env
          echo "SECRET_KEY=supersecret" >> .env
          echo "ALGORITHM=HS256" >> .env
          echo "ACCESS_TOKEN_EXPIRE_MINUTES=60" >> .env
          echo "REFRESH_TOKEN_EXPIRE_DAYS=7" >> .env
          echo "FIRST_SUPERUSER=admin@example.com" >> .env
          echo "FIRST_SUPERUSER_PASSWORD=admin123" >> .env
          echo "MEILI_MASTER_KEY=masterKeyTicketeraSOC" >> .env
          echo "DOMAIN_NAME=localhost" >> .env
          
          docker compose build
          docker compose up -d db redis backend frontend nginx soc-module
          
          echo "Waiting for backend healthcheck..."
          MAX_RETRIES=60
          COUNT=0
          until [ "$(docker inspect -f '{{.State.Health.Status}}' ticketera-backend)" == "healthy" ]; do
              COUNT=$((COUNT+1))
              if [ $COUNT -ge $MAX_RETRIES ]; then
                  echo "Backend healthcheck timeout"
                  docker compose logs backend
                  exit 1
              fi
              echo "Backend is $(docker inspect -f '{{.State.Health.Status}}' ticketera-backend)... ($COUNT/$MAX_RETRIES)"
              sleep 10
          done
          
          echo "Waiting for nginx healthcheck..."
          COUNT=0
          until [ "$(docker inspect -f '{{.State.Health.Status}}' ticketera-nginx)" == "healthy" ]; do
              COUNT=$((COUNT+1))
              if [ $COUNT -ge $MAX_RETRIES ]; then
                  echo "Nginx healthcheck timeout"
                  docker compose logs nginx
                  exit 1
              fi
              echo "Nginx is $(docker inspect -f '{{.State.Health.Status}}' ticketera-nginx)... ($COUNT/$MAX_RETRIES)"
              sleep 10
          done

      - name: Run Total Validation
        run: |
          # Simular validación básica ya que el servicio validator es externo
          docker compose ps
